name: CD Deploy

on:
  push:
    branches: [ github-actions ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python for tests
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: Install dependencies and test
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
        # Быстрые тесты перед деплоем
        python -m pytest tests/test_unit.py -v --tb=short
        
    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Deploy to VM
      run: |
        ssh-keyscan -p 2440 course.prafdin.ru >> ~/.ssh/known_hosts
        
        ssh -p 2440 vboxuser@course.prafdin.ru "
          cd /home/vboxuser/catty-reminders-app
          
          echo 'Pulling latest code...'
          git fetch origin
          git reset --hard origin/github-actions
          
          echo 'Installing/updating dependencies...'
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          echo 'Restarting application service...'
          sudo systemctl daemon-reload
          sudo systemctl restart catty-reminders
          
          echo 'Checking service status...'
          sudo systemctl status catty-reminders --no-pager
          
          echo 'Deployment completed!'
          echo 'Application available at: http://app.agafonov.course.prafdin.ru'
        "
